name: Deploy Rust App

on:
  workflow_call:
    inputs:
      app:
        description: "App matrix assignment"
        required: true
        type: object
      build-path:
        description: "Maps to the docker file BUILD_PATH argument"
        required: true
        type: string
      build-profile:
        description: "Maps to the docker file BUILD_PROFILE argument"
        required: true
        type: string
      tag-prefix:
        description: "Prefix used for docker image tag."
        required: true
        type: string
      k8s-deployment-ns:
        description: "Kubernetes deployment namespace"
        required: true
        type: string
      k8s-ingress-name:
        description: "Kubernetes ingress name"
        required: true
        type: string
      k8s-ingress-tls-name:
        description: "Kubernetes ingress TLS name"
        required: true
        type: string


jobs:
  build_docker_image:
    runs-on: ubuntu-latest
    name: Build and Deploy Docker Image
    steps:
      - name: Checkout (v3)
        uses: actions/checkout@v3
      - name: Execute Docker Build Action
        id: build_action
        uses: ./github/actions/docker-build.yaml
        with:
          dockerfile: rust.Dockerfile
          build-path: ${{ inputs.build-path }}
          build-profile: ${{ inputs.build-profile }}
          app-name: ${{ inputs.app.app-name }}
          tag-prefix: ${{ inputs.tag-prefix }}
      - name: Deploy Image to Kubernetes
        needs: [build_action]
        uses: ./github/actions/deploy-kubernetes.yaml
        with:
          app-name: ${{ inputs.app.app-name }}
          helm-chart: ${{ inputs.app.helm-chart }}
          image-tag: ${{ steps.build_action.outputs.image-tag }}
          k8s-deployment-ns: ${{ inputs.k8s-deployment-ns }}
          k8s-ingress-name: ${{ inputs.k8s-ingress-name }}
          k8s-ingress-tls-name: ${{ inputs.k8s-ingress-tls-name }}
